<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sill Display – Abfahrten</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    header {
      padding: 16px 24px 8px;
      border-bottom: 1px solid #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 10;
      flex-direction: row;
      gap: 16px;
    }

    header-left {
      display: flex;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }

    #station-name {
      display: block;
      font-size: 1.1rem;
      font-weight: 500;
      opacity: 0.9;
      margin-top: 2px;
    }

    #updated {
      font-size: 0.85rem;
      opacity: 0.7;
      text-align: right;
    }

    /* Center clock in header */
    #current-time {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.1rem;
      font-variant-numeric: tabular-nums;
      opacity: 0.9;
    }

    /* Station rotation progress bar */
    .station-progress-container {
      position: relative;
      width: 100%;
      height: 4px;
      background: #020617;
      border-top: 1px solid #111827;
      overflow: hidden;
    }

    .station-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #22c55e, #facc15, #ef4444);
      transform-origin: left center;
    }

    main#scroll-container {
      flex: 1;
      padding: 16px 24px;
      overflow: hidden;
      position: relative;
      z-index: 5;
    }

    .cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card {
      padding: 14px 18px;
      border-radius: 12px;
      background: #030712;
      border: 1px solid #111827;
      display: grid;
      grid-template-columns: 160px 1fr 80px;
      column-gap: 16px;
      align-items: center;
      min-height: 80px;
    }

    .times {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }

    .time-main {
      font-size: 2.2rem;
      line-height: 1;
      font-weight: 600;
    }
    .time-planned { color: #ffffff; }
    .time-rt { color: #f97373; }

    .info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: left;
    }

    .line-dest {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .meta {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    .eta {
      justify-self: flex-end;
      font-size: 1rem;
      font-weight: 500;
      text-align: right;
      white-space: nowrap;
    }

    .eta-soon {
      color: #22c55e;
    }

    .eta-now {
      color: #facc15;
    }

    .eta-past {
      color: #9ca3af;
    }

    .error {
      color: #f97373;
      font-size: 1.1rem;
    }

    .snowflake {
      position: fixed;
      top: -10px;
      color: #ffffff80;
      font-size: 1rem;
      pointer-events: none;
      user-select: none;
      animation: fall linear;
      z-index: 20;
    }

    @keyframes fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(360deg); opacity: 0.3; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Sill Display – Abfahrten</h1>
      <span id="station-name">Lade Station…</span>
    </div>
    <div id="current-time">--:--:--</div>
    <div id="updated">Lade Daten…</div>
  </header>

  <!-- Station rotation progress line -->
  <div class="station-progress-container">
    <div id="station-progress-bar" class="station-progress-bar"></div>
  </div>

  <main id="scroll-container">
    <div id="cards" class="cards"></div>
  </main>

  <script>
    const ROTATION_MS = 10_000;
    const REFRESH_MS = 15_000;

    let stations = [];
    let currentStationIndex = 0;

    /* Clock */
    function updateClock() {
      const clockEl = document.getElementById('current-time');
      const now = new Date();
      clockEl.textContent = now.toLocaleTimeString('de-AT', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    updateClock();
    setInterval(updateClock, 1000);

    function parseTimeToDate(dateStr, timeStr) {
      if (!timeStr) return null;
      const [h, m] = timeStr.split(':').map(Number);
      if (Number.isNaN(h) || Number.isNaN(m)) return null;

      const now = new Date();
      let d;

      if (dateStr) {
        const parsed = new Date(dateStr);
        if (!Number.isNaN(parsed.getTime())) {
          d = parsed;
        } else {
          d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }
      } else {
        d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      }

      d.setHours(h, m, 0, 0);
      return d;
    }

    function formatEta(journey) {
      const targetTime =
        journey.status === 'delayed' && journey.realtimeTime
          ? journey.realtimeTime
          : journey.departure;

      const dt = parseTimeToDate(journey.date, targetTime);
      if (!dt) return { text: '–', className: '' };

      const now = new Date();
      const diffMs = dt.getTime() - now.getTime();
      const diffMin = Math.round(diffMs / 60000);

      if (diffMin <= -1) {
        return { text: 'abgefahren', className: 'eta-past' };
      } else if (diffMin === 0) {
        return { text: 'jetzt', className: 'eta-now' };
      } else if (diffMin === 1) {
        return { text: 'in 1 Min', className: 'eta-soon' };
      } else if (diffMin <= 5) {
        return { text: `in ${diffMin} Min`, className: 'eta-soon' };
      } else {
        return { text: `in ${diffMin} Min`, className: '' };
      }
    }

    async function loadJourneysForStation(evaId) {
      const updatedEl = document.getElementById('updated');
      const cardsEl = document.getElementById('cards');

      try {
        const res = await fetch(`/api/journeys?evaId=${encodeURIComponent(evaId)}`);
        const data = await res.json();

        cardsEl.innerHTML = '';

        if (!res.ok) {
          cardsEl.innerHTML = `<div class="error">${data.message || data.error}</div>`;
          return;
        }

        const journeys = data.journeys || [];

        journeys.forEach(j => {
          const card = document.createElement('div');
          card.className = 'card';

          const times = document.createElement('div');
          times.className = 'times';

          const planned = document.createElement('div');
          planned.className = 'time-main time-planned';
          planned.textContent = j.departure || '--:--';
          times.appendChild(planned);

          if (j.status === 'delayed' && j.realtimeTime && j.realtimeTime !== j.departure) {
            const rt = document.createElement('div');
            rt.className = 'time-main time-rt';
            rt.textContent = j.realtimeTime;
            times.appendChild(rt);
          }

          const info = document.createElement('div');
          info.className = 'info';

          const lineDest = document.createElement('div');
          lineDest.className = 'line-dest';
          const destText = (j.to || '').replace('Innsbruck ', '');
          lineDest.textContent = `${j.tram || ''}: ${destText || '–'}`;

          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.textContent = `ab ${j.from || ''} · ${j.date || ''}`;

          info.appendChild(lineDest);
          info.appendChild(meta);

          const etaInfo = formatEta(j);
          const etaEl = document.createElement('div');
          etaEl.className = 'eta ' + etaInfo.className;
          etaEl.textContent = etaInfo.text;

          card.appendChild(times);
          card.appendChild(info);
          card.appendChild(etaEl);

          cardsEl.appendChild(card);
        });

        updatedEl.textContent =
          'Zuletzt aktualisiert: ' +
          new Date(data.updatedAt || Date.now()).toLocaleTimeString('de-AT', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
      } catch (err) {
        cardsEl.innerHTML = '<div class="error">Fehler beim Laden.</div>';
      }
    }

    function restartProgressAnimation() {
      const bar = document.getElementById('station-progress-bar');
      bar.style.transition = 'none';
      bar.style.width = '0%';

      // force reflow
      void bar.offsetWidth;

      bar.style.transition = `width ${ROTATION_MS}ms linear`;
      bar.style.width = '100%';
    }

    function switchStation(index) {
      if (!stations.length) return;
      currentStationIndex = index % stations.length;
      const station = stations[currentStationIndex];

      const stationNameEl = document.getElementById('station-name');
      stationNameEl.textContent = station.label;

      restartProgressAnimation();
      loadJourneysForStation(station.evaId);
    }

    async function initStations() {
      try {
        const res = await fetch('/api/stations');
        const data = await res.json();
        stations = data.stations || [];

        if (!stations.length) {
          document.getElementById('station-name').textContent = 'Keine Stationen konfiguriert';
          return;
        }

        // Start with first station
        switchStation(0);

        // Rotate station every 10 seconds
        setInterval(() => {
          switchStation((currentStationIndex + 1) % stations.length);
        }, ROTATION_MS);

        // Refresh journeys for current station every 15s
        setInterval(() => {
          if (!stations.length) return;
          const current = stations[currentStationIndex];
          loadJourneysForStation(current.evaId);
        }, REFRESH_MS);
      } catch (e) {
        document.getElementById('station-name').textContent = 'Fehler beim Laden der Stationen';
      }
    }

    initStations();

    /* Snowflakes */
    const snowContainer = document.createElement('div');
    document.body.appendChild(snowContainer);

    function createSnowflake() {
      const snowflake = document.createElement('div');
      snowflake.className = 'snowflake';
      snowflake.textContent = '❄';

      snowflake.style.left = Math.random() * 100 + 'vw';
      snowflake.style.fontSize = (0.6 + Math.random() * 1.4) + 'rem';
      const duration = 4 + Math.random() * 6;
      snowflake.style.animationDuration = duration + 's';
      snowContainer.appendChild(snowflake);

      setTimeout(() => snowflake.remove(), duration * 1000);
    }

    setInterval(createSnowflake, 300);
  </script>
</body>
</html>